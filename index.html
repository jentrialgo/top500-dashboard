<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOP500 Supercomputers Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
            color: #1c1e21;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        h1 {
            color: #1a237e;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .upload-section {
            margin: 20px 0;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        input[type="file"] {
            display: none;
        }

        .file-button {
            background: #1a237e;
            color: white;
            padding: 10px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.2s;
            display: inline-block;
            border: 1px solid #1a237e;
            box-shadow: none;
        }

        .file-button:hover {
            background: #283593;
            transform: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: box-shadow 0.2s;
            border: 1px solid #e1e4e8;
        }

        .stat-card:hover {
            transform: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1a237e;
            margin: 8px 0;
        }

        .stat-label {
            color: #586069;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            height: 400px;
            border: 1px solid #e1e4e8;
        }

        .chart-container h3 {
            color: #24292e;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
        }

        .table-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
            border: 1px solid #e1e4e8;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #24292e;
            font-size: 13px;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5da;
            border-radius: 4px;
            font-size: 14px;
            background-color: #fafbfc;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background: #f6f8fa;
            color: #24292e;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
            border-bottom: 2px solid #e1e4e8;
            font-weight: 600;
        }

        th:hover {
            background: #e1e4e8;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e1e4e8;
            color: #24292e;
        }

        tr:hover {
            background-color: #f6f8fa;
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        canvas {
            max-height: 320px;
        }

        .sort-indicator {
            margin-left: 5px;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üñ•Ô∏è TOP500 Supercomputers Dashboard</h1>
            <div class="upload-section">
                <div class="file-input-wrapper">
                    <label for="fileInput" class="file-button">üìÅ Cargar archivo Excel/CSV</label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.txt">
                </div>
                <div id="fileName" style="margin-top: 10px; color: #666;"></div>
            </div>
        </header>

        <div id="dashboard" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Sistemas</div>
                    <div class="stat-value" id="totalSystems">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Rmax Total (PFlop/s)</div>
                    <div class="stat-value" id="totalRmax">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pa√≠ses Representados</div>
                    <div class="stat-value" id="totalCountries">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Potencia Total (MW)</div>
                    <div class="stat-value" id="totalPower">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Cores</div>
                    <div class="stat-value" id="totalCores">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Eficiencia Media (GFlops/W)</div>
                    <div class="stat-value" id="avgEfficiency">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Fabricantes</div>
                    <div class="stat-value" id="totalManufacturers">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Sistemas con Acelerador</div>
                    <div class="stat-value" id="totalAccelerators">0</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Top 10 Pa√≠ses por N√∫mero de Sistemas</h3>
                    <canvas id="countriesChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Distribuci√≥n por Fabricante</h3>
                    <canvas id="manufacturersChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Sistemas por A√±o</h3>
                    <canvas id="yearChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Top 10 por Rendimiento (Rmax)</h3>
                    <canvas id="performanceChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Top 10 por Eficiencia Energ√©tica</h3>
                    <canvas id="efficiencyChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Rendimiento vs Potencia (Scatter)</h3>
                    <canvas id="scatterChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Distribuci√≥n por Continente</h3>
                    <canvas id="continentChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Familia de Sistemas Operativos</h3>
                    <canvas id="osChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Tecnolog√≠a de Procesador</h3>
                    <canvas id="processorChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Tipo de Acelerador/Co-Procesador</h3>
                    <canvas id="acceleratorChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Familia de Interconexi√≥n</h3>
                    <canvas id="interconnectChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Segmento de Mercado</h3>
                    <canvas id="segmentChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Rendimiento Medio por A√±o (PFlop/s)</h3>
                    <canvas id="avgPerformanceChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Top 10 Pa√≠ses por Rmax Total</h3>
                    <canvas id="countryPerformanceChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Distribuci√≥n de Cores (rangos)</h3>
                    <canvas id="coresDistChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Arquitectura del Sistema</h3>
                    <canvas id="architectureChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <h3 style="color: #1a237e; margin-bottom: 20px;">Explorar Datos</h3>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Buscar</label>
                        <input type="text" id="searchInput" placeholder="Buscar por nombre, pa√≠s, fabricante...">
                    </div>
                    <div class="filter-group">
                        <label>Pa√≠s</label>
                        <select id="countryFilter">
                            <option value="">Todos los pa√≠ses</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Fabricante</label>
                        <select id="manufacturerFilter">
                            <option value="">Todos los fabricantes</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>A√±o</label>
                        <select id="yearFilter">
                            <option value="">Todos los a√±os</option>
                        </select>
                    </div>
                </div>

                <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th data-column="Rank">Rank <span class="sort-indicator"></span></th>
                                <th data-column="Name">Nombre <span class="sort-indicator"></span></th>
                                <th data-column="Country">Pa√≠s <span class="sort-indicator"></span></th>
                                <th data-column="Manufacturer">Fabricante <span class="sort-indicator"></span></th>
                                <th data-column="Year">A√±o <span class="sort-indicator"></span></th>
                                <th data-column="Rmax [TFlop/s]">Rmax (TFlop/s) <span class="sort-indicator"></span></th>
                                <th data-column="Total Cores">Cores <span class="sort-indicator"></span></th>
                                <th data-column="Power (kW)">Potencia (kW) <span class="sort-indicator"></span></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="noData" class="no-data">
            <h2>üëÜ Por favor, carga un archivo Excel o CSV para comenzar</h2>
        </div>
    </div>

    <script>
        let data = [];
        let filteredData = [];
        let sortColumn = 'Rank';
        let sortDirection = 'asc';
        let charts = {};

        // Cargar archivo
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = `Archivo: ${file.name}`;

            const reader = new FileReader();
            const isExcel = file.name.match(/\.(xlsx|xls)$/i);

            if (isExcel) {
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                    processData(jsonData);
                };
                reader.readAsArrayBuffer(file);
            } else {
                reader.onload = function(e) {
                    const content = e.target.result;
                    parseCSV(content);
                };
                reader.readAsText(file);
            }
        });

        function parseCSV(content) {
            const lines = content.split(/\r?\n/);
            
            // Detectar delimitador (tabulador, coma, punto y coma)
            const firstLine = lines[0];
            let delimiter = '\t';
            if (firstLine.split('\t').length < 5) {
                if (firstLine.split(';').length > firstLine.split(',').length) {
                    delimiter = ';';
                } else {
                    delimiter = ',';
                }
            }
            
            console.log('Delimitador detectado:', delimiter === '\t' ? 'TAB' : delimiter);
            
            const headers = lines[0].split(delimiter).map(h => h.trim().replace(/^"|"$/g, ''));
            console.log('Columnas encontradas:', headers.length, headers.slice(0, 5));
            
            data = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(delimiter);
                const row = {};
                
                headers.forEach((header, index) => {
                    let val = values[index] ? values[index].trim().replace(/^"|"$/g, '') : '';
                    row[header] = val;
                });
                
                data.push(row);
            }

            console.log('Filas procesadas:', data.length);
            if (data.length > 0) {
                console.log('Primera fila:', data[0]);
            }

            processData(data);
        }

        function processData(jsonData) {
            data = jsonData.map(row => {
                // Normalizar nombres de columnas (quitar espacios extra)
                const normalized = {};
                Object.keys(row).forEach(key => {
                    normalized[key.trim()] = row[key];
                });
                return normalized;
            });

            console.log('Total de registros:', data.length);
            if (data.length > 0) {
                console.log('Columnas disponibles:', Object.keys(data[0]));
                console.log('Ejemplo de datos:', data[0]);
            }

            if (data.length > 0) {
                filteredData = [...data];
                initializeDashboard();
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('noData').style.display = 'none';
            }
        }

        function initializeDashboard() {
            updateStats();
            updateCharts();
            populateFilters();
            updateTable();
            setupEventListeners();
        }

        function parseNumber(val) {
            if (val === null || val === undefined || val === '') return 0;
            if (typeof val === 'number') return val;
            // Quitar espacios, convertir comas a nada si hay punto decimal, o coma a punto
            let str = String(val).trim();
            // Si tiene formato 1,234,567.89 (ingl√©s)
            if (str.includes('.') && str.includes(',')) {
                str = str.replace(/,/g, '');
            } 
            // Si solo tiene comas, pueden ser separadores de miles
            else if (str.includes(',') && !str.includes('.')) {
                // Verificar si es decimal europeo (1234,56) o miles americano (1,234,567)
                const parts = str.split(',');
                if (parts.length === 2 && parts[1].length <= 2) {
                    // Probablemente decimal europeo
                    str = str.replace(',', '.');
                } else {
                    // Probablemente separadores de miles
                    str = str.replace(/,/g, '');
                }
            }
            const num = parseFloat(str);
            return isNaN(num) ? 0 : num;
        }

        function updateStats() {
            document.getElementById('totalSystems').textContent = data.length;
            
            // Buscar la columna de Rmax (puede tener diferentes nombres)
            const rmaxKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('rmax') || k.toLowerCase().includes('tflop')
            ) || 'Rmax [TFlop/s]';
            
            const totalRmax = data.reduce((sum, item) => {
                return sum + parseNumber(item[rmaxKey]);
            }, 0);
            document.getElementById('totalRmax').textContent = (totalRmax / 1000000).toFixed(2);

            const countries = new Set(data.map(item => item.Country || item.country || item.COUNTRY).filter(c => c));
            document.getElementById('totalCountries').textContent = countries.size;

            // Buscar la columna de Power
            const powerKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('power') && k.toLowerCase().includes('kw')
            ) || 'Power (kW)';
            
            const totalPower = data.reduce((sum, item) => {
                return sum + parseNumber(item[powerKey]);
            }, 0);
            document.getElementById('totalPower').textContent = (totalPower / 1000).toFixed(2);

            // Total Cores
            const coresKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('total cores')
            ) || 'Total Cores';
            const totalCores = data.reduce((sum, item) => {
                return sum + parseNumber(item[coresKey]);
            }, 0);
            document.getElementById('totalCores').textContent = (totalCores / 1000000000).toFixed(2) + 'B';

            // Average Efficiency
            const effKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('efficiency') || k.toLowerCase().includes('gflops/w')
            ) || 'Energy Efficiency [GFlops/Watts]';
            const efficiencyValues = data.map(item => parseNumber(item[effKey])).filter(v => v > 0);
            const avgEfficiency = efficiencyValues.length > 0 
                ? efficiencyValues.reduce((a, b) => a + b, 0) / efficiencyValues.length 
                : 0;
            document.getElementById('avgEfficiency').textContent = avgEfficiency.toFixed(2);

            // Total Manufacturers
            const manufacturers = new Set(data.map(item => getColumn(item, 'Manufacturer', 'manufacturer')).filter(m => m));
            document.getElementById('totalManufacturers').textContent = manufacturers.size;

            // Systems with Accelerators
            const accKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('accelerator') && !k.toLowerCase().includes('cores')
            ) || 'Accelerator/Co-Processor';
            const systemsWithAcc = data.filter(item => {
                const acc = item[accKey];
                return acc && acc.trim() !== '' && acc.toLowerCase() !== 'none';
            }).length;
            document.getElementById('totalAccelerators').textContent = systemsWithAcc;
        }

        function getColumn(row, ...possibleNames) {
            for (const name of possibleNames) {
                // B√∫squeda exacta
                if (row[name] !== undefined) return row[name];
                // B√∫squeda case-insensitive
                const key = Object.keys(row).find(k => k.toLowerCase() === name.toLowerCase());
                if (key) return row[key];
                // B√∫squeda parcial
                const partialKey = Object.keys(row).find(k => k.toLowerCase().includes(name.toLowerCase()));
                if (partialKey) return row[partialKey];
            }
            return '';
        }

        function updateCharts() {
            // Destruir gr√°ficos anteriores
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            // Gr√°fico de pa√≠ses
            const countryCounts = {};
            data.forEach(item => {
                const country = getColumn(item, 'Country', 'country', 'COUNTRY', 'Pa√≠s') || 'Unknown';
                countryCounts[country] = (countryCounts[country] || 0) + 1;
            });
            const topCountries = Object.entries(countryCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            charts.countries = new Chart(document.getElementById('countriesChart'), {
                type: 'bar',
                data: {
                    labels: topCountries.map(c => c[0]),
                    datasets: [{
                        label: 'N√∫mero de Sistemas',
                        data: topCountries.map(c => c[1]),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Gr√°fico de fabricantes
            const manufacturerCounts = {};
            data.forEach(item => {
                const manufacturer = getColumn(item, 'Manufacturer', 'manufacturer', 'Fabricante') || 'Unknown';
                manufacturerCounts[manufacturer] = (manufacturerCounts[manufacturer] || 0) + 1;
            });

            charts.manufacturers = new Chart(document.getElementById('manufacturersChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(manufacturerCounts),
                    datasets: [{
                        data: Object.values(manufacturerCounts),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Gr√°fico por a√±o
            const yearCounts = {};
            data.forEach(item => {
                const year = getColumn(item, 'Year', 'year', 'A√±o') || 'Unknown';
                yearCounts[year] = (yearCounts[year] || 0) + 1;
            });
            const sortedYears = Object.entries(yearCounts).sort((a, b) => a[0] - b[0]);

            charts.year = new Chart(document.getElementById('yearChart'), {
                type: 'line',
                data: {
                    labels: sortedYears.map(y => y[0]),
                    datasets: [{
                        label: 'Sistemas por A√±o',
                        data: sortedYears.map(y => y[1]),
                        borderColor: 'rgba(118, 75, 162, 1)',
                        backgroundColor: 'rgba(118, 75, 162, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Top 10 por rendimiento
            const rmaxKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('rmax')
            ) || 'Rmax [TFlop/s]';
            
            const topPerformance = [...data]
                .sort((a, b) => parseNumber(b[rmaxKey]) - parseNumber(a[rmaxKey]))
                .slice(0, 10);

            charts.performance = new Chart(document.getElementById('performanceChart'), {
                type: 'bar',
                data: {
                    labels: topPerformance.map(item => {
                        const name = getColumn(item, 'Name', 'name', 'Nombre');
                        return name ? name.substring(0, 20) : 'Unknown';
                    }),
                    datasets: [{
                        label: 'Rmax (TFlop/s)',
                        data: topPerformance.map(item => parseNumber(item[rmaxKey])),
                        backgroundColor: 'rgba(255, 99, 132, 0.8)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Top 10 por Eficiencia Energ√©tica
            const effKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('efficiency') || k.toLowerCase().includes('gflops/w')
            ) || 'Energy Efficiency [GFlops/Watts]';
            
            const topEfficiency = [...data]
                .filter(item => parseNumber(item[effKey]) > 0)
                .sort((a, b) => parseNumber(b[effKey]) - parseNumber(a[effKey]))
                .slice(0, 10);

            charts.efficiency = new Chart(document.getElementById('efficiencyChart'), {
                type: 'bar',
                data: {
                    labels: topEfficiency.map(item => {
                        const name = getColumn(item, 'Name', 'name', 'Nombre');
                        return name ? name.substring(0, 20) : 'Unknown';
                    }),
                    datasets: [{
                        label: 'GFlops/Watt',
                        data: topEfficiency.map(item => parseNumber(item[effKey])),
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Scatter: Rendimiento vs Potencia
            const powerKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('power') && k.toLowerCase().includes('kw')
            ) || 'Power (kW)';
            
            const scatterData = data
                .filter(item => parseNumber(item[rmaxKey]) > 0 && parseNumber(item[powerKey]) > 0)
                .map(item => ({
                    x: parseNumber(item[powerKey]),
                    y: parseNumber(item[rmaxKey]),
                    name: getColumn(item, 'Name', 'name', 'Nombre')
                }));

            charts.scatter = new Chart(document.getElementById('scatterChart'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Sistemas',
                        data: scatterData,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Potencia (kW)' } },
                        y: { title: { display: true, text: 'Rmax (TFlop/s)' } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.raw.name}: ${ctx.raw.y.toLocaleString()} TFlop/s, ${ctx.raw.x.toLocaleString()} kW`
                            }
                        }
                    }
                }
            });

            // Distribuci√≥n por Continente
            const continentCounts = {};
            data.forEach(item => {
                const continent = getColumn(item, 'Continent', 'continent', 'Continente') || 'Unknown';
                continentCounts[continent] = (continentCounts[continent] || 0) + 1;
            });

            charts.continent = new Chart(document.getElementById('continentChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(continentCounts),
                    datasets: [{
                        data: Object.values(continentCounts),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Familia de SO
            const osCounts = {};
            data.forEach(item => {
                const os = getColumn(item, 'OS Family', 'os family', 'Operating System') || 'Unknown';
                osCounts[os] = (osCounts[os] || 0) + 1;
            });

            charts.os = new Chart(document.getElementById('osChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(osCounts),
                    datasets: [{
                        data: Object.values(osCounts),
                        backgroundColor: [
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(156, 39, 176, 0.8)',
                            'rgba(0, 150, 136, 0.8)',
                            'rgba(233, 30, 99, 0.8)',
                            'rgba(63, 81, 181, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Tecnolog√≠a de Procesador
            const procCounts = {};
            data.forEach(item => {
                let proc = getColumn(item, 'Processor Technology', 'processor technology', 'Processor') || 'Unknown';
                if (proc.length > 30) proc = proc.substring(0, 30) + '...';
                procCounts[proc] = (procCounts[proc] || 0) + 1;
            });
            const topProcs = Object.entries(procCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);

            charts.processor = new Chart(document.getElementById('processorChart'), {
                type: 'bar',
                data: {
                    labels: topProcs.map(p => p[0]),
                    datasets: [{
                        label: 'Sistemas',
                        data: topProcs.map(p => p[1]),
                        backgroundColor: 'rgba(255, 152, 0, 0.8)',
                        borderColor: 'rgba(255, 152, 0, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Tipo de Acelerador
            const accKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('accelerator') && !k.toLowerCase().includes('cores')
            ) || 'Accelerator/Co-Processor';
            const accCounts = {};
            data.forEach(item => {
                let acc = item[accKey] || 'None';
                if (acc.trim() === '') acc = 'None';
                if (acc.length > 25) acc = acc.substring(0, 25) + '...';
                accCounts[acc] = (accCounts[acc] || 0) + 1;
            });
            const topAccs = Object.entries(accCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);

            charts.accelerator = new Chart(document.getElementById('acceleratorChart'), {
                type: 'bar',
                data: {
                    labels: topAccs.map(a => a[0]),
                    datasets: [{
                        label: 'Sistemas',
                        data: topAccs.map(a => a[1]),
                        backgroundColor: 'rgba(76, 175, 80, 0.8)',
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Familia de Interconexi√≥n
            const interCounts = {};
            data.forEach(item => {
                let inter = getColumn(item, 'Interconnect Family', 'interconnect family', 'Interconnect') || 'Unknown';
                if (inter.length > 25) inter = inter.substring(0, 25) + '...';
                interCounts[inter] = (interCounts[inter] || 0) + 1;
            });
            const topInters = Object.entries(interCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);

            charts.interconnect = new Chart(document.getElementById('interconnectChart'), {
                type: 'polarArea',
                data: {
                    labels: topInters.map(i => i[0]),
                    datasets: [{
                        data: topInters.map(i => i[1]),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 205, 86, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(201, 203, 207, 0.7)',
                            'rgba(102, 126, 234, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Segmento de Mercado
            const segCounts = {};
            data.forEach(item => {
                const seg = getColumn(item, 'Segment', 'segment', 'Segmento') || 'Unknown';
                segCounts[seg] = (segCounts[seg] || 0) + 1;
            });

            charts.segment = new Chart(document.getElementById('segmentChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(segCounts),
                    datasets: [{
                        data: Object.values(segCounts),
                        backgroundColor: [
                            'rgba(33, 150, 243, 0.8)',
                            'rgba(244, 67, 54, 0.8)',
                            'rgba(139, 195, 74, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(156, 39, 176, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Rendimiento Medio por A√±o
            const yearPerformance = {};
            const yearCount2 = {};
            data.forEach(item => {
                const year = getColumn(item, 'Year', 'year', 'A√±o');
                if (year) {
                    const rmax = parseNumber(item[rmaxKey]);
                    yearPerformance[year] = (yearPerformance[year] || 0) + rmax;
                    yearCount2[year] = (yearCount2[year] || 0) + 1;
                }
            });
            const avgByYear = Object.keys(yearPerformance)
                .sort()
                .map(year => ({
                    year,
                    avg: yearPerformance[year] / yearCount2[year] / 1000 // Convert to PFlop/s
                }));

            charts.avgPerformance = new Chart(document.getElementById('avgPerformanceChart'), {
                type: 'line',
                data: {
                    labels: avgByYear.map(y => y.year),
                    datasets: [{
                        label: 'Rmax Medio (PFlop/s)',
                        data: avgByYear.map(y => y.avg),
                        borderColor: 'rgba(233, 30, 99, 1)',
                        backgroundColor: 'rgba(233, 30, 99, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Top 10 Pa√≠ses por Rmax Total
            const countryRmax = {};
            data.forEach(item => {
                const country = getColumn(item, 'Country', 'country', 'Pa√≠s') || 'Unknown';
                const rmax = parseNumber(item[rmaxKey]);
                countryRmax[country] = (countryRmax[country] || 0) + rmax;
            });
            const topCountryRmax = Object.entries(countryRmax)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            charts.countryPerformance = new Chart(document.getElementById('countryPerformanceChart'), {
                type: 'bar',
                data: {
                    labels: topCountryRmax.map(c => c[0]),
                    datasets: [{
                        label: 'Rmax Total (TFlop/s)',
                        data: topCountryRmax.map(c => c[1]),
                        backgroundColor: 'rgba(63, 81, 181, 0.8)',
                        borderColor: 'rgba(63, 81, 181, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Distribuci√≥n de Cores
            const coresKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('total cores')
            ) || 'Total Cores';
            const coreRanges = {
                '< 100K': 0,
                '100K - 500K': 0,
                '500K - 1M': 0,
                '1M - 5M': 0,
                '5M - 10M': 0,
                '> 10M': 0
            };
            data.forEach(item => {
                const cores = parseNumber(item[coresKey]);
                if (cores < 100000) coreRanges['< 100K']++;
                else if (cores < 500000) coreRanges['100K - 500K']++;
                else if (cores < 1000000) coreRanges['500K - 1M']++;
                else if (cores < 5000000) coreRanges['1M - 5M']++;
                else if (cores < 10000000) coreRanges['5M - 10M']++;
                else coreRanges['> 10M']++;
            });

            charts.coresDist = new Chart(document.getElementById('coresDistChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(coreRanges),
                    datasets: [{
                        label: 'N√∫mero de Sistemas',
                        data: Object.values(coreRanges),
                        backgroundColor: 'rgba(0, 150, 136, 0.8)',
                        borderColor: 'rgba(0, 150, 136, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Arquitectura
            const archCounts = {};
            data.forEach(item => {
                const arch = getColumn(item, 'Architecture', 'architecture', 'Arquitectura') || 'Unknown';
                archCounts[arch] = (archCounts[arch] || 0) + 1;
            });

            charts.architecture = new Chart(document.getElementById('architectureChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(archCounts),
                    datasets: [{
                        data: Object.values(archCounts),
                        backgroundColor: [
                            'rgba(96, 125, 139, 0.8)',
                            'rgba(255, 87, 34, 0.8)',
                            'rgba(0, 188, 212, 0.8)',
                            'rgba(121, 85, 72, 0.8)',
                            'rgba(33, 33, 33, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function populateFilters() {
            // Pa√≠ses
            const countries = [...new Set(data.map(item => 
                getColumn(item, 'Country', 'country', 'Pa√≠s')
            ))].filter(c => c).sort();
            const countrySelect = document.getElementById('countryFilter');
            countrySelect.innerHTML = '<option value="">Todos los pa√≠ses</option>';
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });

            // Fabricantes
            const manufacturers = [...new Set(data.map(item => 
                getColumn(item, 'Manufacturer', 'manufacturer', 'Fabricante')
            ))].filter(m => m).sort();
            const manufacturerSelect = document.getElementById('manufacturerFilter');
            manufacturerSelect.innerHTML = '<option value="">Todos los fabricantes</option>';
            manufacturers.forEach(manufacturer => {
                const option = document.createElement('option');
                option.value = manufacturer;
                option.textContent = manufacturer;
                manufacturerSelect.appendChild(option);
            });

            // A√±os
            const years = [...new Set(data.map(item => 
                getColumn(item, 'Year', 'year', 'A√±o')
            ))].filter(y => y).sort((a, b) => b - a);
            const yearSelect = document.getElementById('yearFilter');
            yearSelect.innerHTML = '<option value="">Todos los a√±os</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('countryFilter').addEventListener('change', applyFilters);
            document.getElementById('manufacturerFilter').addEventListener('change', applyFilters);
            document.getElementById('yearFilter').addEventListener('change', applyFilters);

            // Ordenamiento de columnas
            document.querySelectorAll('th[data-column]').forEach(th => {
                th.addEventListener('click', function() {
                    const column = this.dataset.column;
                    if (sortColumn === column) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = column;
                        sortDirection = 'asc';
                    }
                    updateTable();
                });
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const countryFilter = document.getElementById('countryFilter').value;
            const manufacturerFilter = document.getElementById('manufacturerFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;

            filteredData = data.filter(item => {
                const matchesSearch = !searchTerm || 
                    Object.values(item).some(val => 
                        String(val).toLowerCase().includes(searchTerm)
                    );
                const itemCountry = getColumn(item, 'Country', 'country', 'Pa√≠s');
                const itemManufacturer = getColumn(item, 'Manufacturer', 'manufacturer', 'Fabricante');
                const itemYear = String(getColumn(item, 'Year', 'year', 'A√±o'));
                
                const matchesCountry = !countryFilter || itemCountry === countryFilter;
                const matchesManufacturer = !manufacturerFilter || itemManufacturer === manufacturerFilter;
                const matchesYear = !yearFilter || itemYear === yearFilter;

                return matchesSearch && matchesCountry && matchesManufacturer && matchesYear;
            });

            updateTable();
        }

        function updateTable() {
            // Encontrar las claves reales de las columnas
            const sample = data[0] || {};
            const rankKey = Object.keys(sample).find(k => k.toLowerCase() === 'rank') || 'Rank';
            const nameKey = Object.keys(sample).find(k => k.toLowerCase() === 'name') || 'Name';
            const countryKey = Object.keys(sample).find(k => k.toLowerCase() === 'country') || 'Country';
            const manufacturerKey = Object.keys(sample).find(k => k.toLowerCase() === 'manufacturer') || 'Manufacturer';
            const yearKey = Object.keys(sample).find(k => k.toLowerCase() === 'year') || 'Year';
            const rmaxKey = Object.keys(sample).find(k => k.toLowerCase().includes('rmax')) || 'Rmax [TFlop/s]';
            const coresKey = Object.keys(sample).find(k => k.toLowerCase().includes('total cores')) || 'Total Cores';
            const powerKey = Object.keys(sample).find(k => k.toLowerCase().includes('power') && k.toLowerCase().includes('kw')) || 'Power (kW)';

            // Mapeo de columnas para ordenamiento
            const columnMapping = {
                'Rank': rankKey,
                'Name': nameKey,
                'Country': countryKey,
                'Manufacturer': manufacturerKey,
                'Year': yearKey,
                'Rmax [TFlop/s]': rmaxKey,
                'Total Cores': coresKey,
                'Power (kW)': powerKey
            };

            const actualSortColumn = columnMapping[sortColumn] || sortColumn;

            // Ordenar datos
            const sorted = [...filteredData].sort((a, b) => {
                let valA = a[actualSortColumn] || '';
                let valB = b[actualSortColumn] || '';

                // Intentar convertir a n√∫mero
                const numA = parseNumber(valA);
                const numB = parseNumber(valB);

                if (numA !== 0 || numB !== 0) {
                    return sortDirection === 'asc' ? numA - numB : numB - numA;
                }

                return sortDirection === 'asc' 
                    ? String(valA).localeCompare(String(valB))
                    : String(valB).localeCompare(String(valA));
            });

            // Actualizar indicadores de ordenamiento
            document.querySelectorAll('.sort-indicator').forEach(span => span.textContent = '');
            const activeHeader = document.querySelector(`th[data-column="${sortColumn}"] .sort-indicator`);
            if (activeHeader) {
                activeHeader.textContent = sortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
            }

            // Renderizar tabla
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            sorted.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item[rankKey] || '-'}</td>
                    <td><strong>${item[nameKey] || '-'}</strong></td>
                    <td>${item[countryKey] || '-'}</td>
                    <td>${item[manufacturerKey] || '-'}</td>
                    <td>${item[yearKey] || '-'}</td>
                    <td>${item[rmaxKey] || '-'}</td>
                    <td>${item[coresKey] || '-'}</td>
                    <td>${item[powerKey] || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
