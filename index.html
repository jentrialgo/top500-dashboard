<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOP500 Supercomputers Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-body: #F7F7F9;
            --bg-card: #FFFFFF;
            --text-main: #11142D;
            --text-secondary: #808191;
            --primary: #6C5DD3;
            --primary-light: #CFC8FF;
            --success: #4FD1C5;
            --warning: #FFCE73; 
            --danger: #FF754C;
            --info: #3F8CFF;
            --border-color: #E4E4E4;
            --card-shadow: 0 10px 40px rgba(226, 230, 245, 0.6);
            --card-radius: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-body);
            padding: 24px;
            color: var(--text-main);
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
        }

        header {
            background: var(--bg-card);
            padding: 24px 32px;
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: none;
        }

        h1 {
            color: var(--text-main);
            font-weight: 700;
            font-size: 24px;
            margin: 0;
            letter-spacing: -0.5px;
        }

        .upload-section {
            margin: 0;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        input[type="file"] {
            display: none;
        }

        .file-button {
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.2s;
            display: inline-block;
            border: none;
            box-shadow: 0 4px 12px rgba(108, 93, 211, 0.3);
        }

        .file-button:hover {
            background: #5b4eb8;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(108, 93, 211, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            text-align: left;
            transition: transform 0.2s;
            border: none;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-main);
            margin: 8px 0;
            letter-spacing: -1px;
            z-index: 1;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            z-index: 1;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-container {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            height: 420px;
            border: none;
        }

        .chart-container h3 {
            color: var(--text-main);
            margin-bottom: 24px;
            text-align: left;
            font-weight: 700;
            font-size: 18px;
        }

        .table-container {
            background: var(--bg-card);
            padding: 32px;
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            overflow-x: auto;
            border: none;
        }

        .filters {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .view-mode-toggle {
            display: flex;
            background: var(--bg-body);
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 24px;
            width: fit-content;
            position: sticky;
            top: 20px;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .view-mode-button {
            padding: 8px 16px;
            border-radius: 10px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-mode-button.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid transparent;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: all 0.2s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary);
            background-color: #fff;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
        }

        th {
            background: var(--bg-card);
            color: var(--text-secondary);
            padding: 16px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 13px;
        }

        th:hover {
            color: var(--primary);
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-main);
            font-weight: 600; vertical-align: middle;
        }
        
        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: rgba(108, 93, 211, 0.04);
        }

        .no-data {
            text-align: center;
            padding: 80px;
            color: var(--text-secondary);
        }

        canvas {
            max-height: 340px;
        }

        .sort-indicator {
            margin-left: 5px;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .filters {
                flex-direction: column;
            }
        }
    </style>
    <!-- Add Google Font DM Sans -->
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1>üñ•Ô∏è TOP500 Supercomputers Dashboard</h1>
            <div class="upload-section">
                <div class="file-input-wrapper">
                    <label for="fileInput" class="file-button">üìÅ Upload Excel/CSV File</label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.txt">
                </div>
                <div id="fileName" style="margin-top: 10px; color: #666;"></div>
            </div>
        </header>

        <div id="dashboard" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(108, 93, 211, 0.1); color: #6C5DD3;">üñ•Ô∏è</div>
                    <div class="stat-label">Total Systems</div>
                    <div class="stat-value" id="totalSystems">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(255, 117, 76, 0.1); color: #FF754C;">üöÄ</div>
                    <div class="stat-label">Total Rmax (PFlop/s)</div>
                    <div class="stat-value" id="totalRmax">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(63, 140, 255, 0.1); color: #3F8CFF;">üåç</div>
                    <div class="stat-label">Countries Represented</div>
                    <div class="stat-value" id="totalCountries">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(255, 206, 115, 0.1); color: #FFCE73;">‚ö°</div>
                    <div class="stat-label">Total Power (MW)</div>
                    <div class="stat-value" id="totalPower">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(255, 162, 192, 0.1); color: #FFA2C0;">üß†</div>
                    <div class="stat-label">Total Cores</div>
                    <div class="stat-value" id="totalCores">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(79, 209, 197, 0.1); color: #4FD1C5;">üå±</div>
                    <div class="stat-label">Average Efficiency (GFlops/W)</div>
                    <div class="stat-value" id="avgEfficiency">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(160, 215, 231, 0.1); color: #A0D7E7;">üè≠</div>
                    <div class="stat-label">Manufacturers</div>
                    <div class="stat-value" id="totalManufacturers">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(207, 200, 255, 0.1); color: #CFC8FF;">‚ö°</div>
                    <div class="stat-label">Systems with Accelerator</div>
                    <div class="stat-value" id="totalAccelerators">0</div>
                </div>
            </div>

            <div class="view-mode-toggle">
                <button class="view-mode-button active" data-mode="system">System Share (Counts)</button>
                <button class="view-mode-button" data-mode="performance">Performance Share (Rmax)</button>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Top 10 Countries by Number of Systems</h3>
                    <canvas id="countriesChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Distribution by Manufacturer</h3>
                    <canvas id="manufacturersChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Systems by Year</h3>
                    <canvas id="yearChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Top 10 by Performance (Rmax)</h3>
                    <canvas id="performanceChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Top 10 by Energy Efficiency</h3>
                    <canvas id="efficiencyChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Performance vs Power (Scatter)</h3>
                    <canvas id="scatterChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Distribution by Continent</h3>
                    <canvas id="continentChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Operating System Family</h3>
                    <canvas id="osChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Processor Technology</h3>
                    <canvas id="processorChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Processor by CPU Architecture</h3>
                    <canvas id="cpuArchChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Accelerator/Co-Processor Type</h3>
                    <canvas id="acceleratorChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Interconnect Family</h3>
                    <canvas id="interconnectChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Market Segment</h3>
                    <canvas id="segmentChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Average Performance per Year (PFlop/s)</h3>
                    <canvas id="avgPerformanceChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Top 10 Countries by Total Rmax</h3>
                    <canvas id="countryPerformanceChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Cores Distribution (Ranges)</h3>
                    <canvas id="coresDistChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>System Architecture</h3>
                    <canvas id="architectureChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <h3>Explore Data</h3>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Search</label>
                        <input type="text" id="searchInput" placeholder="Search by name, country, manufacturer...">
                    </div>
                    <div class="filter-group">
                        <label>Country</label>
                        <select id="countryFilter">
                            <option value="">All Countries</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Manufacturer</label>
                        <select id="manufacturerFilter">
                            <option value="">All Manufacturers</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Year</label>
                        <select id="yearFilter">
                            <option value="">All Years</option>
                        </select>
                    </div>
                </div>

                <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th data-column="Rank">Rank <span class="sort-indicator"></span></th>
                                <th data-column="Name">Name <span class="sort-indicator"></span></th>
                                <th data-column="Country">Country <span class="sort-indicator"></span></th>
                                <th data-column="Manufacturer">Manufacturer <span class="sort-indicator"></span></th>
                                <th data-column="Year">Year <span class="sort-indicator"></span></th>
                                <th data-column="Rmax [TFlop/s]">Rmax (TFlop/s) <span class="sort-indicator"></span></th>
                                <th data-column="Total Cores">Cores <span class="sort-indicator"></span></th>
                                <th data-column="Power (kW)">Power (kW) <span class="sort-indicator"></span></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="noData" class="no-data">
            <h2>üëÜ Please upload an Excel or CSV file to start</h2>
        </div>
    </div>

    <script>
        let data = [];
        let filteredData = [];
        let sortColumn = 'Rank';
        let sortDirection = 'asc';
        let charts = {};
        let viewMode = 'system'; // 'system' or 'performance'
        let labelColorMap = {}; // Stable color mapping for categories

        // Load file
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = `File: ${file.name}`;

            const reader = new FileReader();
            const isExcel = file.name.match(/\.(xlsx|xls)$/i);

            if (isExcel) {
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
                    processData(jsonData);
                };
                reader.readAsArrayBuffer(file);
            } else {
                reader.onload = function(e) {
                    const content = e.target.result;
                    parseCSV(content);
                };
                reader.readAsText(file);
            }
        });

        function parseCSV(content) {
            const lines = content.split(/\r?\n/);
            
            // Detect delimiter (tab, comma, semicolon)
            const firstLine = lines[0];
            let delimiter = '\t';
            if (firstLine.split('\t').length < 5) {
                if (firstLine.split(';').length > firstLine.split(',').length) {
                    delimiter = ';';
                } else {
                    delimiter = ',';
                }
            }
            
            console.log('Delimiter detected:', delimiter === '\t' ? 'TAB' : delimiter);
            
            const headers = lines[0].split(delimiter).map(h => h.trim().replace(/^"|"$/g, ''));
            console.log('Columns found:', headers.length, headers.slice(0, 5));
            
            data = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split(delimiter);
                const row = {};
                
                headers.forEach((header, index) => {
                    let val = values[index] ? values[index].trim().replace(/^"|"$/g, '') : '';
                    row[header] = val;
                });
                
                data.push(row);
            }

            console.log('Rows processed:', data.length);
            if (data.length > 0) {
                console.log('First row:', data[0]);
            }

            processData(data);
        }

        function processData(jsonData) {
            // Reset color map when new data is loaded
            labelColorMap = {};
            
            data = jsonData.map(row => {
                // Normalize column names (remove extra spaces)
                const normalized = {};
                Object.keys(row).forEach(key => {
                    normalized[key.trim()] = row[key];
                });
                return normalized;
            });

            console.log('Total records:', data.length);
            if (data.length > 0) {
                console.log('Available columns:', Object.keys(data[0]));
                console.log('Data example:', data[0]);
            }

            if (data.length > 0) {
                filteredData = [...data];
                initializeDashboard();
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('noData').style.display = 'none';
            }
        }

        function initializeDashboard() {
            // Global Chart.js configuration
            Chart.defaults.font.family = "'DM Sans', sans-serif";
            Chart.defaults.color = '#808191';
            Chart.defaults.borderColor = '#E4E4E4';

            // Register datalabels plugin once (if available) and DISABLE datalabels globally
            if (window.ChartDataLabels && !Chart._datalabelsRegistered) {
                Chart.register(ChartDataLabels);
                Chart._datalabelsRegistered = true;
            }
            // Ensure datalabels are turned off across all charts (keeps plugin available for future use)
            Chart.defaults.plugins.datalabels = Chart.defaults.plugins.datalabels || {};
            Chart.defaults.plugins.datalabels.display = false;

            updateStats();
            updateCharts();
            populateFilters();
            updateTable();
            setupEventListeners();
        }

        function parseNumber(val) {
            if (val === null || val === undefined || val === '') return 0;
            if (typeof val === 'number') return val;
            let str = String(val).trim();
            if (str.includes('.') && str.includes(',')) {
                str = str.replace(/,/g, '');
            } else if (str.includes(',') && !str.includes('.')) {
                const parts = str.split(',');
                if (parts.length === 2 && parts[1].length <= 2) {
                    str = str.replace(',', '.');
                } else {
                    str = str.replace(/,/g, '');
                }
            }
            const num = parseFloat(str);
            return isNaN(num) ? 0 : num;
        }

        // Format numbers: integers shown without decimals; decimals rounded to max 2 places
        function formatNumberNice(n) {
            if (n === null || n === undefined || n === '') return '';
            const num = typeof n === 'number' ? n : parseNumber(n);
            if (!isFinite(num)) return String(n);
            // If essentially an integer, show without decimals
            if (Math.abs(num - Math.round(num)) < 1e-9) return num.toLocaleString();
            return num.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        }

        // Global tooltip formatter: round decimals to 2 places when present
        Chart.defaults.plugins.tooltip.callbacks.label = function(ctx) {
            const parsed = ctx.parsed;
            // Number value (bar/line/pie)
            if (typeof parsed === 'number') {
                const label = ctx.dataset && ctx.dataset.label ? `${ctx.dataset.label}: ` : '';
                return label + formatNumberNice(parsed);
            }

            // Object value (scatter -> {x, y})
            if (typeof parsed === 'object' && parsed !== null) {
                const parts = [];
                if (parsed.x !== undefined) parts.push(`x: ${formatNumberNice(parsed.x)}`);
                if (parsed.y !== undefined) parts.push(`y: ${formatNumberNice(parsed.y)}`);
                return parts.join(', ');
            }

            return String(parsed);
        };

        // Theme colors
        const themeColors = {
            primary: '#6C5DD3',
            primaryLight: 'rgba(108, 93, 211, 0.2)',
            success: '#4FD1C5',
            warning: '#FFCE73',
            danger: '#FF754C',
            info: '#3F8CFF',
            palette: [
                '#6C5DD3', // Purple
                '#4FD1C5', // Teal
                '#FFCE73', // Yellow
                '#FF754C', // Orange Red
                '#3F8CFF', // Blue
                '#FFA2C0', // Pink
                '#A0D7E7', // Light Blue
                '#CFC8FF', // Light Purple
                '#7BD389', // Green
                '#E04F5F', // Red
                '#B08968', // Brown/Tan
                '#00C2A8'  // Cyan/Teal
            ]
        };

        function updateStats() {
            document.getElementById('totalSystems').textContent = data.length;
            
            const rmaxKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('rmax') || k.toLowerCase().includes('tflop')
            ) || 'Rmax [TFlop/s]';
            
            const totalRmax = data.reduce((sum, item) => {
                return sum + parseNumber(item[rmaxKey]);
            }, 0);
            document.getElementById('totalRmax').textContent = (totalRmax / 1000000).toFixed(2);

            const countries = new Set(data.map(item => item.Country || item.country || item.COUNTRY).filter(c => c));
            document.getElementById('totalCountries').textContent = countries.size;

            const powerKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('power') && k.toLowerCase().includes('kw')
            ) || 'Power (kW)';
            
            const totalPower = data.reduce((sum, item) => {
                return sum + parseNumber(item[powerKey]);
            }, 0);
            document.getElementById('totalPower').textContent = (totalPower / 1000).toFixed(2);

            const coresKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('total cores')
            ) || 'Total Cores';
            const totalCores = data.reduce((sum, item) => {
                return sum + parseNumber(item[coresKey]);
            }, 0);
            document.getElementById('totalCores').textContent = (totalCores / 1000000000).toFixed(2) + 'B';

            const effKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('efficiency') || k.toLowerCase().includes('gflops/w')
            ) || 'Energy Efficiency [GFlops/Watts]';
            const efficiencyValues = data.map(item => parseNumber(item[effKey])).filter(v => v > 0);
            const avgEfficiency = efficiencyValues.length > 0 
                ? efficiencyValues.reduce((a, b) => a + b, 0) / efficiencyValues.length 
                : 0;
            document.getElementById('avgEfficiency').textContent = avgEfficiency.toFixed(2);

            const manufacturers = new Set(data.map(item => getColumn(item, 'Manufacturer', 'manufacturer')).filter(m => m));
            document.getElementById('totalManufacturers').textContent = manufacturers.size;

            const accKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('accelerator') && !k.toLowerCase().includes('cores')
            ) || 'Accelerator/Co-Processor';
            const systemsWithAcc = data.filter(item => {
                const acc = item[accKey];
                return acc && acc.trim() !== '' && acc.toLowerCase() !== 'none';
            }).length;
            document.getElementById('totalAccelerators').textContent = systemsWithAcc;
        }

        function getColumn(row, ...possibleNames) {
            for (const name of possibleNames) {
                if (row[name] !== undefined) return row[name];
                const key = Object.keys(row).find(k => k.toLowerCase() === name.toLowerCase());
                if (key) return row[key];
                const partialKey = Object.keys(row).find(k => k.toLowerCase().includes(name.toLowerCase()));
                if (partialKey) return row[partialKey];
            }
            return '';
        }

        function getAggregatedData(columnNames) {
            const counts = {};
            const rmaxKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('rmax') || k.toLowerCase().includes('tflop')
            ) || 'Rmax [TFlop/s]';
            
            data.forEach(item => {
                let val = getColumn(item, ...columnNames) || 'Unknown';
                if (val.length > 40) val = val.substring(0, 40) + '...';
                
                if (viewMode === 'system') {
                    counts[val] = (counts[val] || 0) + 1;
                } else {
                    counts[val] = (counts[val] || 0) + parseNumber(item[rmaxKey]);
                }
            });
            return counts;
        }

        function getChartLabel() {
            return viewMode === 'system' ? 'Systems' : 'Rmax (TFlop/s)';
        }

        // Helper to get consistent color for labels across chart updates
        function getColorForLabel(label) {
            const normalized = String(label).trim();
            if (!normalized || normalized === 'Other' || normalized === 'Unknown' || normalized === 'None' || normalized === 'N/A') {
                return '#E6E9EE'; // Neutral grey for others
            }
            if (labelColorMap[normalized]) return labelColorMap[normalized];
            
            const colorIndex = Object.keys(labelColorMap).length % themeColors.palette.length;
            labelColorMap[normalized] = themeColors.palette[colorIndex];
            return labelColorMap[normalized];
        }

        function updateCharts() {
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            const isPerf = viewMode === 'performance';
            const shareLabel = isPerf ? '(Performance Share)' : '(System Share)';

            const rmaxKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('rmax')
            ) || 'Rmax [TFlop/s]';

            // Helper to update container h3
            const updateH3 = (id, text) => {
                const canvas = document.getElementById(id);
                if (canvas) {
                    const h3 = canvas.closest('.chart-container').querySelector('h3');
                    if (h3) h3.textContent = text;
                }
            };

            // 1. Countries Chart
            updateH3('countriesChart', `Top 10 Countries ${shareLabel}`);
            const countryCounts = getAggregatedData(['Country', 'country', 'Pa√≠s']);
            const topCountries = Object.entries(countryCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            charts.countries = new Chart(document.getElementById('countriesChart'), {
                type: 'bar',
                data: {
                    labels: topCountries.map(c => c[0]),
                    datasets: [{
                        label: getChartLabel(),
                        data: topCountries.map(c => c[1]),
                        backgroundColor: themeColors.primary,
                        borderRadius: 8,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            grid: { display: true, drawBorder: false },
                            ticks: {
                                callback: function(value) {
                                    return formatNumberNice(value);
                                }
                            }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });

            // 2. Manufacturers Chart
            updateH3('manufacturersChart', `Distribution by Manufacturer ${shareLabel}`);
            const manufacturerCounts = getAggregatedData(['Manufacturer', 'manufacturer', 'Fabricante']);

            // Sort manufacturers and split into topN + other
            const sortedMfg = Object.entries(manufacturerCounts).sort((a, b) => b[1] - a[1]);
            const topN = 8;
            const topMfg = sortedMfg.slice(0, topN);
            const otherMfg = sortedMfg.slice(topN);
            const otherTotal = otherMfg.reduce((s, x) => s + x[1], 0);

            const mfgLabels = topMfg.map(x => x[0]);
            const mfgData = topMfg.map(x => x[1]);
            if (otherTotal > 0) {
                mfgLabels.push('Other');
                mfgData.push(otherTotal);
            }

            const colors = mfgLabels.map(label => getColorForLabel(label));

            charts.manufacturers = new Chart(document.getElementById('manufacturersChart'), {
                type: 'doughnut',
                data: {
                    labels: mfgLabels,
                    datasets: [{
                        data: mfgData,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        title: {
                            display: true,
                            text: `Distribution by Manufacturer (${viewMode === 'system' ? 'Systems' : 'Performance'})`
                        },
                        legend: {
                            display: true,
                            position: 'right',
                            labels: { usePointStyle: true, padding: 12, boxWidth: 12 }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const value = ctx.parsed;
                                    const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
                                    const pct = total > 0 ? (value / total * 100).toFixed(1) : '0.0';
                                    const label = viewMode === 'system' ? 'systems' : 'TFlop/s';
                                    return `${ctx.label}: ${formatNumberNice(value)} ${label} (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // 3. Year Chart
            const yearCounts = getAggregatedData(['Year', 'year', 'A√±o']);
            const sortedYears = Object.entries(yearCounts).sort((a, b) => a[0] - b[0]);

            charts.year = new Chart(document.getElementById('yearChart'), {
                type: 'line',
                data: {
                    labels: sortedYears.map(y => y[0]),
                    datasets: [{
                        label: viewMode === 'system' ? 'Systems by Year' : 'Performance by Year (TFlop/s)',
                        data: sortedYears.map(y => y[1]),
                        borderColor: themeColors.success,
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                            gradient.addColorStop(0, 'rgba(79, 209, 197, 0.5)');
                            gradient.addColorStop(1, 'rgba(79, 209, 197, 0)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: themeColors.success,
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${viewMode === 'system' ? 'Systems' : 'Performance'} by Year`
                        }
                    }
                }
            });

            // 4. Top 10 by Performance (Always performance)
            const topPerformance = [...data]
                .sort((a, b) => parseNumber(b[rmaxKey]) - parseNumber(a[rmaxKey]))
                .slice(0, 10);

            charts.performance = new Chart(document.getElementById('performanceChart'), {
                type: 'bar',
                data: {
                    labels: topPerformance.map(item => {
                        const name = getColumn(item, 'Name', 'name', 'Nombre');
                        return name ? name.substring(0, 20) : 'Unknown';
                    }),
                    datasets: [{
                        label: 'Rmax (TFlop/s)',
                        data: topPerformance.map(item => parseNumber(item[rmaxKey])),
                        backgroundColor: themeColors.danger,
                        borderRadius: 8,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        title: { display: true, text: 'Top 10 Systems by Performance' }
                    },
                    scales: {
                        x: { display: false },
                        y: { grid: { display: false } }
                    }
                }
            });

            // 5. Top 10 by Energy Efficiency
            const effKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('efficiency') || k.toLowerCase().includes('gflops/w')
            ) || 'Energy Efficiency [GFlops/Watts]';
            
            const topEfficiency = [...data]
                .filter(item => parseNumber(item[effKey]) > 0)
                .sort((a, b) => parseNumber(b[effKey]) - parseNumber(a[effKey]))
                .slice(0, 10);

            charts.efficiency = new Chart(document.getElementById('efficiencyChart'), {
                type: 'bar',
                data: {
                    labels: topEfficiency.map(item => {
                        const name = getColumn(item, 'Name', 'name', 'Nombre');
                        return name ? name.substring(0, 20) : 'Unknown';
                    }),
                    datasets: [{
                        label: 'GFlops/Watt',
                        data: topEfficiency.map(item => parseNumber(item[effKey])),
                        backgroundColor: themeColors.success,
                        borderRadius: 8,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        title: { display: true, text: 'Top 10 Systems by Energy Efficiency' }
                    },
                    scales: {
                        x: { display: false },
                        y: { grid: { display: false } }
                    }
                }
            });

            // 6. Scatter: Performance vs Power
            const powerKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('power') && k.toLowerCase().includes('kw')
            ) || 'Power (kW)';
            
            const scatterData = data
                .filter(item => parseNumber(item[rmaxKey]) > 0 && parseNumber(item[powerKey]) > 0)
                .map(item => ({
                    x: parseNumber(item[powerKey]),
                    y: parseNumber(item[rmaxKey]),
                    name: getColumn(item, 'Name', 'name', 'Nombre')
                }));

            charts.scatter = new Chart(document.getElementById('scatterChart'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Systems',
                        data: scatterData,
                        backgroundColor: themeColors.info,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Power (kW)' }, grid: { drawBorder: false } },
                        y: { title: { display: true, text: 'Rmax (TFlop/s)' }, grid: { drawBorder: false } }
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#11142D',
                            bodyColor: '#808191',
                            borderColor: '#E4E4E4',
                            borderWidth: 1,
                            callbacks: {
                                label: (ctx) => `${ctx.raw.name}: ${formatNumberNice(ctx.raw.y)} TFlop/s`
                            }
                        }
                    }
                }
            });

            // 7. Distribution by Continent
            updateH3('continentChart', `Distribution by Continent ${shareLabel}`);
            const continentCounts = getAggregatedData(['Continent', 'continent', 'Continente']);

            charts.continent = new Chart(document.getElementById('continentChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(continentCounts),
                    datasets: [{
                        data: Object.values(continentCounts),
                        backgroundColor: Object.keys(continentCounts).map(l => getColorForLabel(l)),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // 8. OS Family
            updateH3('osChart', `Operating System Family ${shareLabel}`);
            const osCounts = getAggregatedData(['OS Family', 'os family', 'Operating System']);

            charts.os = new Chart(document.getElementById('osChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(osCounts),
                    datasets: [{
                        data: Object.values(osCounts),
                        backgroundColor: Object.keys(osCounts).map(l => getColorForLabel(l)),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%'
                }
            });

            // 9. Processor Technology
            updateH3('processorChart', `Processor Technology ${shareLabel}`);
            const procCounts = getAggregatedData(['Processor Technology', 'processor technology', 'Processor']);
            const topProcs = Object.entries(procCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);

            charts.processor = new Chart(document.getElementById('processorChart'), {
                type: 'bar',
                data: {
                    labels: topProcs.map(p => p[0]),
                    datasets: [{
                        label: getChartLabel(),
                        data: topProcs.map(p => p[1]),
                        backgroundColor: themeColors.warning,
                        borderRadius: 8,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            grid: { borderDash: [5, 5] },
                            ticks: { callback: (v) => formatNumberNice(v) }
                        }
                    }
                }
            });

            // 9.5. CPU Architecture Classification
            updateH3('cpuArchChart', `CPU Architecture Distribution ${shareLabel}`);
            const archStats = {};
            data.forEach(item => {
                const tech = getColumn(item, 'Processor Technology', 'processor technology') || '';
                const proc = getColumn(item, 'Processor', 'processor') || '';
                const combined = (tech + ' ' + proc).toLowerCase();
                
                let category = 'Other';
                if (combined.includes('intel') || combined.includes('xeon')) category = 'Intel';
                else if (combined.includes('amd') || combined.includes('epyc') || combined.includes('zen')) category = 'AMD';
                else if (combined.includes('arm') || combined.includes('a64fx') || combined.includes('grace') || combined.includes('graviton') || combined.includes('thunderx') || combined.includes('neoverse')) category = 'ARM';
                
                const value = viewMode === 'system' ? 1 : parseNumber(item[rmaxKey]);
                archStats[category] = (archStats[category] || 0) + value;
            });

            charts.cpuArch = new Chart(document.getElementById('cpuArchChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(archStats),
                    datasets: [{
                        data: Object.values(archStats),
                        backgroundColor: Object.keys(archStats).map(l => {
                            if (l === 'Intel') return '#0071C5'; // Intel Blue
                            if (l === 'AMD') return '#ED1C24';   // AMD Red
                            if (l === 'ARM') return '#374151';   // ARM Dark Grey
                            return '#E6E9EE';                   // Other
                        }),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { usePointStyle: true, padding: 12 }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const value = ctx.parsed;
                                    const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
                                    const pct = total > 0 ? (value / total * 100).toFixed(1) : '0.0';
                                    const label = viewMode === 'system' ? 'systems' : 'TFlop/s';
                                    return `${ctx.label}: ${formatNumberNice(value)} ${label} (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // 10. Accelerator Type
            updateH3('acceleratorChart', `Accelerator/Co-Processor Type ${shareLabel}`);
            const accCounts = getAggregatedData(['Accelerator/Co-Processor', 'Accelerator']);
            const topAccs = Object.entries(accCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);

            charts.accelerator = new Chart(document.getElementById('acceleratorChart'), {
                type: 'bar',
                data: {
                    labels: topAccs.map(a => a[0]),
                    datasets: [{
                        label: getChartLabel(),
                        data: topAccs.map(a => a[1]),
                        backgroundColor: themeColors.primary,
                        borderRadius: 8,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false }
                    },
                    scales: {
                        y: { ticks: { callback: (v) => formatNumberNice(v) } }
                    }
                }
            });

            // 11. Interconnect Family
            updateH3('interconnectChart', `Interconnect Family ${shareLabel}`);
            const interCounts = getAggregatedData(['Interconnect Family', 'interconnect family', 'Interconnect']);
            const topInters = Object.entries(interCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);

            charts.interconnect = new Chart(document.getElementById('interconnectChart'), {
                type: 'doughnut',
                data: {
                    labels: topInters.map(i => i[0]),
                    datasets: [{
                        data: topInters.map(i => i[1]),
                        backgroundColor: topInters.map(i => getColorForLabel(i[0])),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });

            // 12. Market Segment
            updateH3('segmentChart', `Market Segment ${shareLabel}`);
            const segCounts = getAggregatedData(['Segment', 'segment', 'Segmento']);

            charts.segment = new Chart(document.getElementById('segmentChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(segCounts),
                    datasets: [{
                        data: Object.values(segCounts),
                        backgroundColor: Object.keys(segCounts).map(l => getColorForLabel(l)),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '50%'
                }
            });

            // 13. Average Performance per Year
            const yearPerformance = {};
            const yearCount2 = {};
            data.forEach(item => {
                const year = getColumn(item, 'Year', 'year', 'A√±o');
                if (year) {
                    const rmax = parseNumber(item[rmaxKey]);
                    yearPerformance[year] = (yearPerformance[year] || 0) + rmax;
                    yearCount2[year] = (yearCount2[year] || 0) + 1;
                }
            });
            const avgByYear = Object.keys(yearPerformance)
                .sort()
                .map(year => ({
                    year,
                    avg: yearPerformance[year] / yearCount2[year] / 1000 // Convert to PFlop/s
                }));

            charts.avgPerformance = new Chart(document.getElementById('avgPerformanceChart'), {
                type: 'line',
                data: {
                    labels: avgByYear.map(y => y.year),
                    datasets: [{
                        label: 'Average Rmax (PFlop/s)',
                        data: avgByYear.map(y => y.avg),
                        borderColor: themeColors.danger,
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                            gradient.addColorStop(0, 'rgba(255, 117, 76, 0.5)');
                            gradient.addColorStop(1, 'rgba(255, 117, 76, 0)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    }
                }
            });

            // 14. Top 10 Countries by Total Performance (Repurposed to be dynamic or kept consistent)
            const countryPerfData = getAggregatedData(['Country', 'country', 'Pa√≠s']);
            const topCountryPerf = Object.entries(countryPerfData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            charts.countryPerformance = new Chart(document.getElementById('countryPerformanceChart'), {
                type: 'bar',
                data: {
                    labels: topCountryPerf.map(c => c[0]),
                    datasets: [{
                        label: getChartLabel(),
                        data: topCountryPerf.map(c => c[1]),
                        backgroundColor: themeColors.info,
                        borderRadius: 8,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        title: { display: true, text: `Top 10 Countries by ${viewMode === 'system' ? 'Systems' : 'Performance'}` }
                    },
                    scales: {
                        y: { ticks: { callback: (v) => formatNumberNice(v) } }
                    }
                }
            });

            // 15. Cores Distribution
            const coresKey = Object.keys(data[0] || {}).find(k => 
                k.toLowerCase().includes('total cores')
            ) || 'Total Cores';
            const coreRanges = {
                '< 100K': 0,
                '100K - 500K': 0,
                '500K - 1M': 0,
                '1M - 5M': 0,
                '5M - 10M': 0,
                '> 10M': 0
            };
            data.forEach(item => {
                const cores = parseNumber(item[coresKey]);
                let label = '';
                if (cores < 100000) label = '< 100K';
                else if (cores < 500000) label = '100K - 500K';
                else if (cores < 1000000) label = '500K - 1M';
                else if (cores < 5000000) label = '1M - 5M';
                else if (cores < 10000000) label = '5M - 10M';
                else label = '> 10M';

                if (viewMode === 'system') {
                    coreRanges[label]++;
                } else {
                    coreRanges[label] += parseNumber(item[rmaxKey]);
                }
            });

            charts.coresDist = new Chart(document.getElementById('coresDistChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(coreRanges),
                    datasets: [{
                        label: getChartLabel(),
                        data: Object.values(coreRanges),
                        backgroundColor: themeColors.primary,
                        borderRadius: 8,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        title: { display: true, text: `Cores Distribution (${viewMode === 'system' ? 'Systems' : 'Performance'})` }
                    },
                    scales: {
                        y: { ticks: { callback: (v) => formatNumberNice(v) } }
                    }
                }
            });

            // 16. Architecture
            const archCounts = getAggregatedData(['Architecture', 'architecture', 'Arquitectura']);

            charts.architecture = new Chart(document.getElementById('architectureChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(archCounts),
                    datasets: [{
                        data: Object.values(archCounts),
                        backgroundColor: Object.keys(archCounts).map(l => getColorForLabel(l)),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        title: { display: true, text: `Architecture Share (${viewMode === 'system' ? 'Systems' : 'Performance'})` }
                    }
                }
            });
        }

        function populateFilters() {
            // Countries
            const countries = [...new Set(data.map(item => 
                getColumn(item, 'Country', 'country', 'Pa√≠s')
            ))].filter(c => c).sort();
            const countrySelect = document.getElementById('countryFilter');
            countrySelect.innerHTML = '<option value="">All Countries</option>';
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });

            // Manufacturers
            const manufacturers = [...new Set(data.map(item => 
                getColumn(item, 'Manufacturer', 'manufacturer', 'Fabricante')
            ))].filter(m => m).sort();
            const manufacturerSelect = document.getElementById('manufacturerFilter');
            manufacturerSelect.innerHTML = '<option value="">All Manufacturers</option>';
            manufacturers.forEach(manufacturer => {
                const option = document.createElement('option');
                option.value = manufacturer;
                option.textContent = manufacturer;
                manufacturerSelect.appendChild(option);
            });

            // Years
            const years = [...new Set(data.map(item => 
                getColumn(item, 'Year', 'year', 'A√±o')
            ))].filter(y => y).sort((a, b) => b - a);
            const yearSelect = document.getElementById('yearFilter');
            yearSelect.innerHTML = '<option value="">All Years</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('countryFilter').addEventListener('change', applyFilters);
            document.getElementById('manufacturerFilter').addEventListener('change', applyFilters);
            document.getElementById('yearFilter').addEventListener('change', applyFilters);

            // View mode toggle
            document.querySelectorAll('.view-mode-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.view-mode-button').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    viewMode = this.dataset.mode;
                    updateCharts();
                });
            });

            // Column sorting
            document.querySelectorAll('th[data-column]').forEach(th => {
                th.addEventListener('click', function() {
                    const column = this.dataset.column;
                    if (sortColumn === column) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = column;
                        sortDirection = 'asc';
                    }
                    updateTable();
                });
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const countryFilter = document.getElementById('countryFilter').value;
            const manufacturerFilter = document.getElementById('manufacturerFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;

            filteredData = data.filter(item => {
                const matchesSearch = !searchTerm || 
                    Object.values(item).some(val => 
                        String(val).toLowerCase().includes(searchTerm)
                    );
                const itemCountry = getColumn(item, 'Country', 'country', 'Pa√≠s');
                const itemManufacturer = getColumn(item, 'Manufacturer', 'manufacturer', 'Fabricante');
                const itemYear = String(getColumn(item, 'Year', 'year', 'A√±o'));
                
                const matchesCountry = !countryFilter || itemCountry === countryFilter;
                const matchesManufacturer = !manufacturerFilter || itemManufacturer === manufacturerFilter;
                const matchesYear = !yearFilter || itemYear === yearFilter;

                return matchesSearch && matchesCountry && matchesManufacturer && matchesYear;
            });

            updateTable();
        }

        function updateTable() {
            // Find actual column keys
            const sample = data[0] || {};
            const rankKey = Object.keys(sample).find(k => k.toLowerCase() === 'rank') || 'Rank';
            const nameKey = Object.keys(sample).find(k => k.toLowerCase() === 'name') || 'Name';
            const countryKey = Object.keys(sample).find(k => k.toLowerCase() === 'country') || 'Country';
            const manufacturerKey = Object.keys(sample).find(k => k.toLowerCase() === 'manufacturer') || 'Manufacturer';
            const yearKey = Object.keys(sample).find(k => k.toLowerCase() === 'year') || 'Year';
            const rmaxKey = Object.keys(sample).find(k => k.toLowerCase().includes('rmax')) || 'Rmax [TFlop/s]';
            const coresKey = Object.keys(sample).find(k => k.toLowerCase().includes('total cores')) || 'Total Cores';
            const powerKey = Object.keys(sample).find(k => k.toLowerCase().includes('power') && k.toLowerCase().includes('kw')) || 'Power (kW)';

            // Column mapping for sort
            const columnMapping = {
                'Rank': rankKey,
                'Name': nameKey,
                'Country': countryKey,
                'Manufacturer': manufacturerKey,
                'Year': yearKey,
                'Rmax [TFlop/s]': rmaxKey,
                'Total Cores': coresKey,
                'Power (kW)': powerKey
            };

            const actualSortColumn = columnMapping[sortColumn] || sortColumn;

            // Sort data
            const sorted = [...filteredData].sort((a, b) => {
                let valA = a[actualSortColumn] || '';
                let valB = b[actualSortColumn] || '';

                // Try to convert to number
                const numA = parseNumber(valA);
                const numB = parseNumber(valB);

                if (numA !== 0 || numB !== 0) {
                    return sortDirection === 'asc' ? numA - numB : numB - numA;
                }

                return sortDirection === 'asc' 
                    ? String(valA).localeCompare(String(valB))
                    : String(valB).localeCompare(String(valA));
            });

            // Update sort indicators
            document.querySelectorAll('.sort-indicator').forEach(span => span.textContent = '');
            const activeHeader = document.querySelector(`th[data-column="${sortColumn}"] .sort-indicator`);
            if (activeHeader) {
                activeHeader.textContent = sortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
            }

            // Render table
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            sorted.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item[rankKey] || '-'}</td>
                    <td><strong>${item[nameKey] || '-'}</strong></td>
                    <td>${item[countryKey] || '-'}</td>
                    <td>${item[manufacturerKey] || '-'}</td>
                    <td>${item[yearKey] || '-'}</td>
                    <td>${item[rmaxKey] || '-'}</td>
                    <td>${item[coresKey] || '-'}</td>
                    <td>${item[powerKey] || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
